error_page 403 = @modsec_deny;

location @modsec_deny {
    internal;

    # Extract rule information from our custom ModSecurity headers
    set $rule_id $sent_http_rule_triggered;
    set $rule_msg $sent_http_msg_triggered;
    
    # Fallback to standard ModSec headers if custom headers not available
    if ($rule_id = "") {
        set $rule_id $sent_http_x_modsec_ruleid;
    }
    
    # Set default values if no rule info available
    if ($rule_id = "") {
        set $rule_id "UNKNOWN";
    }
    if ($rule_msg = "") {
        set $rule_msg "Security policy violation detected";
    }

    add_header X-Frame-Options "DENY" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "no-referrer" always;
    default_type text/html;
    return 403 '<!DOCTYPE html><html><head><title>Access Denied</title><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;display:flex;align-items:center;justify-content:center;color:#333}.container{background:rgba(255,255,255,0.95);backdrop-filter:blur(10px);border-radius:20px;padding:40px;max-width:500px;width:90%;box-shadow:0 20px 40px rgba(0,0,0,0.1);text-align:center;border:1px solid rgba(255,255,255,0.2)}.shield{width:60px;height:60px;margin:0 auto 20px;background:linear-gradient(135deg,#ff6b6b,#ee5a24);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:30px;color:white;animation:pulse 2s infinite}@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}h1{color:#2c3e50;font-size:1.8em;margin-bottom:10px}p{color:#7f8c8d;margin-bottom:20px}.details{background:#f8f9fa;padding:20px;margin:20px 0;border-radius:8px;border-left:4px solid #e74c3c;text-align:left}.row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #eee}.row:last-child{border-bottom:none}.label{font-weight:600;color:#495057}.value{font-family:monospace;background:#fff;padding:4px 8px;border-radius:4px;color:#e74c3c;font-weight:bold;word-break:break-all}.contact{background:#e8f4f8;padding:20px;margin:20px 0;border-radius:8px;border-left:4px solid #17a2b8;text-align:left}.contact h3{color:#2c3e50;margin-bottom:10px;font-size:1.1em}.contact-row{display:flex;align-items:center;margin:8px 0;padding:8px 0}.contact-label{font-weight:600;color:#495057;min-width:80px}.contact-link{color:#17a2b8;text-decoration:none;font-family:monospace;background:#fff;padding:4px 8px;border-radius:4px;border:1px solid #b8daff}.contact-link:hover{background:#17a2b8;color:white}.footer{margin-top:20px;padding-top:15px;border-top:1px solid #eee;color:#999;font-size:0.85em}@media(max-width:600px){.container{margin:20px;padding:30px 20px}.row,.contact-row{flex-direction:column;align-items:flex-start;gap:5px}.value,.contact-link{width:100%}}</style></head><body><div class="container"><div class="shield">üõ°Ô∏è</div><h1>Access Denied</h1><p>Request blocked by Web Application Firewall</p><div class="details"><div class="row"><span class="label">Rule ID:</span><span class="value">$rule_id</span></div><div class="row"><span class="label">Violation:</span><span class="value">$rule_msg</span></div><div class="row"><span class="label">Time:</span><span class="value">$time_iso8601</span></div><div class="row"><span class="label">IP:</span><span class="value">$remote_addr</span></div></div><div class="contact"><h3>Need Help? Contact Us</h3><div class="contact-row"><span class="contact-label">Discord:</span><a href="https://discord.gg/bBUj7x35aQ" class="contact-link" target="_blank">discord.gg/bBUj7x35aQ</a></div><div class="contact-row"><span class="contact-label">Email:</span><a href="mailto:me@julio.al" class="contact-link">me@julio.al</a></div></div><div class="footer"><p><strong>Reference:</strong> WAF-$time_iso8601-$rule_id</p></div></div></body></html>';
}
